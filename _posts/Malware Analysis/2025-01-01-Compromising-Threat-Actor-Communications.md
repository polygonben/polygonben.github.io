---
title: "Compromising Threat Actor Communications"
categories:
  - Malware Analysis
toc: true
---

Traditionally, the vast majority of malware would communicate to a threat actor owned server via a threat actor owned domain or IP address. This domain or IP would likely be hardcoded within the malware sample somewhere, such that when executed, it would reach out to establish Command and Control (C2). This technique for C2 still remains prevalent, but there has been an observed shift into threat actors using trusted services, like Slack, Discord, or Telegram for these communications.

Using trusted services allow malware to “hide in plain sight.” Network defenders typically whitelist or don’t scrutinize traffic to well-known platforms. By shifting C2 communications to these channels, attackers can bypass many conventional security controls and delay detection. The website [LOLC2](https://lolc2.github.io/) details a list of legitimate services that can be abused by C2. There are some noteable entries in the list, including [CounterStrike 1.6](https://github.com/eversinc33/1.6-C2) or [Lichess](https://github.com/0x-Apollyon/Malnus-Carlware). These are more niche entries, developed for fun, but services like Telegram being abused for C2 remains a prevalent threat. 

This blog post highlights how we as defenders, or cyber-threat intelligence analysts, can exploit certain pitfalls in the way Telegram-based malware operates - in order to compromise C2 communications and disrupt adversaries. As a result of this research, I've discovered one particular actor who **stupidly** tested their own keylogging & infostealing malware on their own production "hacking" machine. From this, we can gain insight into this particular actors back-end infrastructure, including other cybercrime operations they are currently running. This case-study has stemmed out of current research I'm performing that looks into automating malware analysis & the collection of threat intel at scale, using data from VirusTotal. 

## Telegram for C2

Where Telegram C2 is used, network connections to `api.telegram[.]org` are observed from the malware, rather than network connections to a malicious domain. Each strain of malware that uses Telegram for C2 may operate differently, but we can generalise the kill chain to the below steps:

1. Bot Setup: The attacker registers a new bot via Telegram’s BotFather, receiving a unique token.

2. Malware Deployment: The malware, embedded with the bot token and possibly a unique identifier for the infected host, is distributed to victims.

3. Command Polling: Infected systems periodically make API requests to Telegram’s servers to check for new commands sent to the bot. The bot might reside in a private channel or group where only the attacker has posting rights.

4. Command Execution: Upon receiving a command, the malware executes instructions on the victim machine. These could range from downloading additional payloads to exfiltrating data.

5. Data Exfiltration: The malware may send results or stolen data back to the attacker via the same Telegram bot channel, completing the C2 loop. 

[![1](/assets/images/CompComms/telegram.jpg)](/assets/images/CompComms/telegram.jpg){: .full}

From my research, it appears the vast majority of malware samples (which use Telegram for C2), are infostealers or keyloggers - for the intent of stealing credentials, cookies & credit card information. Although there has been evidence that sophisticated actors, like the North Korean Lazarus Group have used [Telegram-based](https://blog.talosintelligence.com/lazarus_new_rats_dlang_and_telegram/) RATs, all the samples I've analysed can be attributed to low-tier cybercriminals or skids. 
 
## The Vulnerability

To highlight once again, referencing the above kill-chain, malware that uses Telegram Bots to facilicate communications or for exfiltration, must be embedded with this bot token. The creation of this bot, and the corresponding bot token, can be completed manually messaging the Telegram user @BotFather:

[![2](/assets/images/CompComms/CreateBot.png)](/assets/images/CompComms/CreateBot.png){: .full}

The pertinent message here is "Keep your token **secure** and **store it safely**, it can be used by anyone to control your bot". If we can manage to get our hands on an threat actors bot token, we can perform a range of actions - from forwarding all messages the bot has sent, to deleting webhooks associated with the bot. 

Thankfully, it is **trivial** to get our hands on these bot tokens. I currently have 400+ actor owned bot tokens in storage, all relating to a infostealer that has been developed using modified AsyncRAT source code. The collection of these bot tokens was fully automated using VirusTotal, and I will be releasing the source code to this in due time. The case study I'll be detailing does not involve this infostealer, but a AgentTesla sample. 

With these bot tokens to hand, exploitation is also trivial. [Any.Run](https://any.run/cybersecurity-blog/intercept-stolen-data-in-telegram/) has released a [blog post](https://any.run/cybersecurity-blog/intercept-stolen-data-in-telegram/) & [set of scripts](https://github.com/anyrun/blog-scripts/tree/main/Scripts/TelegramAPI) detailing how you can delete webhooks and forward communications. The instructions of how to use these scripts will not be explained during this blog post and instead I'll be looking at one particular case study during my research. I encourage those who are interested to check out the Any.Run research for further details. 


### Hunting for targets

I mentioned it is trivial to get our hands on samples for exploitation, but how exactly can we perform this? With access to VirusTotal's [RetroHunt](https://docs.virustotal.com/docs/retrohunt) or [LiveHunt](https://docs.virustotal.com/docs/livehunt) we can develop a rule to look for potentially malicious files that communicate with `api.telegram[.]org`, the using the below YARA rule for example:

```
rule TelegramAPIMalware_PowerShell
{
  meta:
    author = "@polygonben"
    description = "Hunting for pwsh malware using Telegram for C2"
    target_entity = "file"
  condition:
    vt.metadata.file_type == vt.FileType.POWERSHELL and
    vt.metadata.analysis_stats.malicious > 5 and
    for any http_traffic in vt.behaviour.http_conversations: (
    http_traffic.url contains "api.telegram.org"
)
```

This will find all Powershell scripts, that have over 5 VT detections, that have made network connections with `api.telegram[.]org`. You can hunt for various different filetypes, including Windows PEs (Executables), which return a much large number of hits. 

If you don't have access to VirusTotal LiveHunt or RetroHunt, you perform OSINT to try identify samples. [MalwareBazaar](https://bazaar.abuse.ch/browse/tag/api-telegram-org/) has a smaller collection of samples that are taggged with `api-telegram-org`. Furthermore, specific Google dorks like `"api.telegram.org" site:joesandbox.com` may also assist in finding targets for exploitation. 

However, the easiest method is to use VirusTotal, as this can facililate the mass collection of samples, for which the extraction of tokens can be easily automated. 

## Case Study

This case study will look at one particular sample that was found using the aforementioned YARA rule. The case study will be primarily focused in looking at the major mistake made by the threat actor that led to me having access to 20+ screenshots & logs of keystrokes from his host used for initiating attacks. The full malware analysis can be seen [here]

The file which was identified was [8e6thc.ps1 (466b9beeb51926c9d9ae9d538a2da037)](https://www.virustotal.com/gui/file/9ef489493d3fffa0d8e43b6a189d471430ba0fdc33def06d0e43d809413d5837/detection).

[![3](/assets/images/CompComms/PS1_Detection.png)](/assets/images/CompComms/PS1_Detection.png){: .full}

Looking at the VirusTotal [Relations](https://www.virustotal.com/gui/file/9ef489493d3fffa0d8e43b6a189d471430ba0fdc33def06d0e43d809413d5837/relations) or [Behavior](https://www.virustotal.com/gui/file/9ef489493d3fffa0d8e43b6a189d471430ba0fdc33def06d0e43d809413d5837/behavior) tabs, we can **instantly** get access to this Bots token & `chat_id` fields used for stealing the communications. 

[![3](/assets/images/CompComms/PS1_Relations.png)](/assets/images/CompComms/PS1_Relations.png){: .full}

It is possible to manually extract these, rather relying on sandbox telemetry, and we will cover this in the full malware analysis post.